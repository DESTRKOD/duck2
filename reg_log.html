<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.2/lottie.min.js"></script>
<style>
/* ===== –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò ===== */
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(180deg, #0b3c91 0%, #1565c0 55%, #42a5f5 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

/* ===== –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ===== */
.auth-screen {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 20px;
  box-sizing: border-box;
  width: 100%;
  max-width: 320px;
}

/* ===== LOTTIE –ê–ù–ò–ú–ê–¶–ò–Ø ===== */
.sticker {
  width: 200px;
  height: 200px;
  margin-bottom: 20px;
}

@media (max-width: 480px) {
  .sticker {
    width: 160px;
    height: 160px;
  }
}

/* ===== –ó–ê–ì–û–õ–û–í–û–ö ===== */
.title {
  margin: 0 0 30px 0;
  font-size: 24px;
  font-weight: 800;
  color: #fff;
  text-align: center;
}

@media (max-width: 480px) {
  .title {
    font-size: 22px;
    margin-bottom: 25px;
  }
}

/* ===== –ö–ù–û–ü–ö–ò –ö–ê–ö –í –û–°–ù–û–í–ù–û–ú –°–ê–ô–¢–ï ===== */
.button {
  width: 100%;
  max-width: 280px;
  margin: 0 0 12px 0;
  padding: 20px 0;
  font-size: 18px;
  font-weight: 800;
  background: #fff;
  color: #0b3c91;
  border-radius: 18px;
  box-shadow: 0 16px 36px rgba(0,0,0,.45);
  transition: all .15s ease;
  user-select: none;
  cursor: pointer;
  border: none;
  outline: none;
  text-align: center;
  display: block;
  position: relative;
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è (hover) */
.button:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 40px rgba(0,0,0,.5);
}

/* –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è (active/pressed) */
.button.pressed {
  transform: translateY(6px) scale(.95);
  box-shadow: 0 6px 14px rgba(0,0,0,.35);
}

.button:disabled {
  background: #cccccc;
  color: #666666;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: 0 8px 20px rgba(0,0,0,.25) !important;
}

.button.loading-state {
  position: relative;
  color: transparent;
}

.button.loading-state::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(11, 60, 145, 0.3);
  border-top-color: #0b3c91;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  top: 50%;
  left: 50%;
  margin-top: -10px;
  margin-left: -10px;
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

/* ===== –¢–ï–ö–°–¢ –ü–û–î –ö–ù–û–ü–ö–ê–ú–ò ===== */
.telegram-note {
  margin-top: 20px;
  color: rgba(255,255,255,0.8);
  font-size: 14px;
  text-align: center;
  max-width: 280px;
  line-height: 1.4;
}

@media (max-width: 480px) {
  .telegram-note {
    font-size: 13px;
    margin-top: 15px;
  }
}

/* ===== –°–¢–ê–¢–£–°–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø ===== */
.status-message {
  margin-top: 20px;
  padding: 12px 16px;
  border-radius: 14px;
  font-size: 14px;
  font-weight: 700;
  text-align: center;
  display: none;
  width: 100%;
  max-width: 280px;
  box-sizing: border-box;
}

.status-loading {
  background: rgba(255,255,255,0.1);
  color: white;
  border-left: 4px solid #4fc3f7;
  animation: pulse 1.5s infinite;
}

.status-success {
  background: rgba(0,200,83,0.15);
  color: white;
  border-left: 4px solid #00c853;
}

.status-error {
  background: rgba(255,45,85,0.15);
  color: white;
  border-left: 4px solid #ff2d55;
  animation: shake 0.5s ease-in-out;
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.7;
  }
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

/* ===== –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ===== */
@media (max-width: 360px) {
  .auth-screen {
    padding: 15px;
  }
  
  .title {
    font-size: 20px;
    margin-bottom: 20px;
  }
  
  .button {
    padding: 18px 0;
    font-size: 16px;
    max-width: 260px;
  }
  
  .telegram-note {
    font-size: 12px;
    max-width: 260px;
  }
}

/* –î–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±–µ–∑ hover (–º–æ–±–∏–ª—å–Ω—ã–µ) */
@media (hover: none) {
  .button:hover {
    transform: none;
    box-shadow: 0 16px 36px rgba(0,0,0,.45);
  }
}
</style>
</head>

<body>
<div class="auth-screen">
  <!-- Lottie –∞–Ω–∏–º–∞—Ü–∏—è -->
  <div id="lottie-animation" class="sticker"></div>
  
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
  <div class="title">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –º–∞–≥–∞–∑–∏–Ω–µ</div>
  
  <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
  <button class="button" id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –≤—Ö–æ–¥–∞ -->
  <button class="button" id="loginBtn">–í–æ–π—Ç–∏</button>
  
  <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
  <button class="button" id="backBtn">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–∞–≥–∞–∑–∏–Ω</button>
  
  <!-- –¢–µ–∫—Å—Ç –ø—Ä–æ Telegram -->
  <div class="telegram-note">* –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è Telegram</div>
  
  <!-- –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
  <div class="status-message status-loading" id="loadingMessage">
    ‚è≥ –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram...
  </div>
  
  <div class="status-message status-success" id="successMessage">
    ‚úÖ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Telegram –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
  </div>
  
  <div class="status-message status-error" id="errorMessage"></div>
</div>

<script>
const API_URL = 'https://duck-shop-sever.onrender.com';
const SITE_URL = 'https://DESTRKOD.github.io/duck2';

// –≠–ª–µ–º–µ–Ω—Ç—ã
const registerBtn = document.getElementById('registerBtn');
const loginBtn = document.getElementById('loginBtn');
const backBtn = document.getElementById('backBtn');
const loadingMessage = document.getElementById('loadingMessage');
const successMessage = document.getElementById('successMessage');
const errorMessage = document.getElementById('errorMessage');

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Lottie –∞–Ω–∏–º–∞—Ü–∏–∏
function initLottieAnimation() {
  try {
    lottie.loadAnimation({
      container: document.getElementById('lottie-animation'),
      renderer: 'svg',
      loop: true,
      autoplay: true,
      path: 'reg_log.json' // –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
    });
  } catch (e) {
    console.log('Lottie –∞–Ω–∏–º–∞—Ü–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    document.getElementById('lottie-animation').innerHTML = 'üîê';
  }
}

// –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Å—Ç–∞—Ç—É—Å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
function showStatus(type, message = '') {
  loadingMessage.style.display = 'none';
  successMessage.style.display = 'none';
  errorMessage.style.display = 'none';
  
  switch(type) {
    case 'loading':
      loadingMessage.style.display = 'block';
      break;
    case 'success':
      successMessage.style.display = 'block';
      break;
    case 'error':
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      break;
  }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π –¥–ª—è –∫–Ω–æ–ø–∫–∏
function setupButtonAnimations(button) {
  // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –ø—Ä–∏ pointerdown (–∫–∞—Å–∞–Ω–∏–µ/–Ω–∞–∂–∞—Ç–∏–µ –º—ã—à–∏)
  button.addEventListener('pointerdown', () => {
    button.classList.add('pressed');
  });
  
  // –£–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ pointerup (–æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ)
  button.addEventListener('pointerup', () => {
    button.classList.remove('pressed');
  });
  
  // –£–±–∏—Ä–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç –µ—Å–ª–∏ —É—à–ª–∏ —Å –∫–Ω–æ–ø–∫–∏ –Ω–µ –æ—Ç–ø—É—Å—Ç–∏–≤
  button.addEventListener('pointerleave', () => {
    button.classList.remove('pressed');
  });
  
  // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –º—ã—à—å—é
  button.addEventListener('mousedown', () => {
    button.classList.add('pressed');
  });
  
  button.addEventListener('mouseup', () => {
    button.classList.remove('pressed');
  });
  
  button.addEventListener('mouseleave', () => {
    button.classList.remove('pressed');
  });
  
  // –î–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
  button.addEventListener('touchstart', (e) => {
    e.preventDefault();
    button.classList.add('pressed');
  });
  
  button.addEventListener('touchend', (e) => {
    e.preventDefault();
    button.classList.remove('pressed');
  });
  
  button.addEventListener('touchcancel', () => {
    button.classList.remove('pressed');
  });
  
  // –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ (–¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
  button.addEventListener('focus', () => {
    button.style.outline = '2px solid #4fc3f7';
    button.style.outlineOffset = '2px';
  });
  
  button.addEventListener('blur', () => {
    button.style.outline = 'none';
  });
}

// –ù–∞–∑–∞–¥ –≤ –º–∞–≥–∞–∑–∏–Ω
backBtn.addEventListener('click', () => {
  // –≠—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
  backBtn.classList.add('pressed');
  setTimeout(() => {
    backBtn.classList.remove('pressed');
    window.location.href = `${SITE_URL}/beta-duck.html`;
  }, 200);
});

// –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
async function handleAuth(endpoint, button) {
  // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
  button.classList.add('pressed');
  setTimeout(() => {
    if (!button.classList.contains('loading-state')) {
      button.classList.remove('pressed');
    }
  }, 150);
  
  button.disabled = true;
  button.classList.add('loading-state');
  
  showStatus('loading');
  
  try {
    const response = await fetch(`${API_URL}/api/auth/${endpoint}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    const data = await response.json();
    
    if (data.success) {
      showStatus('success');
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
      button.disabled = false;
      button.classList.remove('loading-state');
      button.classList.remove('pressed');
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º Telegram —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
      setTimeout(() => {
        window.open(data.telegramLink, '_blank');
      }, 1000);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      const checkInterval = setInterval(async () => {
        const checkResponse = await fetch(`${API_URL}/api/auth/check/${data.token}`);
        const checkData = await checkResponse.json();
        
        if (checkData.success && checkData.authenticated) {
          clearInterval(checkInterval);
          
          // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–∞–≥–∞–∑–∏–Ω
          window.location.href = `${SITE_URL}/beta-duck.html?auth=${data.token}`;
          
        } else if (checkData.success && checkData.expired) {
          clearInterval(checkInterval);
          button.disabled = false;
          button.classList.remove('loading-state');
          button.classList.remove('pressed');
          showStatus('error', '‚ùå –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∏—Å—Ç–µ–∫–ª–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        }
      }, 2000);
      
      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è 5 –º–∏–Ω—É—Ç–∞–º–∏
      setTimeout(() => {
        clearInterval(checkInterval);
      }, 5 * 60 * 1000);
      
    } else {
      button.disabled = false;
      button.classList.remove('loading-state');
      button.classList.remove('pressed');
      showStatus('error', `‚ùå ${data.error || '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'}`);
    }
  } catch (err) {
    button.disabled = false;
    button.classList.remove('loading-state');
    button.classList.remove('pressed');
    showStatus('error', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
  }
}

// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
registerBtn.addEventListener('click', () => {
  handleAuth('start-register', registerBtn);
});

// –í—Ö–æ–¥
loginBtn.addEventListener('click', () => {
  handleAuth('start-login', loginBtn);
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
  initLottieAnimation();
  
  // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  setupButtonAnimations(registerBtn);
  setupButtonAnimations(loginBtn);
  setupButtonAnimations(backBtn);
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
  const urlParams = new URLSearchParams(window.location.search);
  const authToken = urlParams.get('auth');
  
  if (authToken) {
    // –ï—Å–ª–∏ –ø–µ—Ä–µ—à–ª–∏ —Å —Ç–æ–∫–µ–Ω–æ–º, —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º
    verifyAuthToken(authToken);
  }
});

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞
async function verifyAuthToken(token) {
  try {
    showStatus('loading', '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...');
    
    const response = await fetch(`${API_URL}/api/auth/check/${token}`);
    const data = await response.json();
    
    if (data.success && data.authenticated) {
      // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
      const newUrl = window.location.pathname;
      window.history.replaceState({}, '', newUrl);
      
      // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –º–∞–≥–∞–∑–∏–Ω
      window.location.href = `${SITE_URL}/beta-duck.html`;
    } else {
      showStatus('error', '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω');
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–∞:', error);
    showStatus('error', '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
  }
}
</script>
</body>
</html>
